"use strict";(self.webpackChunkroutr_docs=self.webpackChunkroutr_docs||[]).push([[7305],{9447:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var o=t(4848),r=t(8453);const s={},i="Location Service",c={id:"development/components/location",title:"Location Service",description:"In Routr, the Location Service serves two primary purposes. The first purpose is to locate the route to an endpoint in the location table. The second is to load balance requests.",source:"@site/versioned_docs/version-2.0.0/development/components/location.md",sourceDirName:"development/components",slug:"/development/components/location",permalink:"/docs/2.0.0/development/components/location",draft:!1,unlisted:!1,editUrl:"https://github.com/fonoster/routr-website/edit/main/versioned_docs/version-2.0.0/development/components/location.md",tags:[],version:"2.0.0",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Message Dispatcher",permalink:"/docs/2.0.0/development/components/dispatcher"},next:{title:"Registry Service",permalink:"/docs/2.0.0/development/components/registry"}},a={},d=[{value:"Configuration Spec",id:"configuration-spec",level:2},{value:"Communication and Protobuf Spec",id:"communication-and-protobuf-spec",level:2},{value:"Launching the Location Service with Docker",id:"launching-the-location-service-with-docker",level:2},{value:"Quick Test with gRPCurl",id:"quick-test-with-grpcurl",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"location-service",children:"Location Service"}),"\n",(0,o.jsx)(n.p,{children:"In Routr, the Location Service serves two primary purposes. The first purpose is to locate the route to an endpoint in the location table. The second is to load balance requests."}),"\n",(0,o.jsx)(n.p,{children:"Routr's load balancing is done at the Location Service level and occurs in the context of Peers. To better explain this, let's take a closer look at some applications where this is useful."}),"\n",(0,o.jsx)(n.p,{children:"For example, you can create a Peer configuration and share the same credentials if you have multiple Asterisk servers. By doing this, Routr will send a request to the instance of Asterisk according to the load-balancing algorithm you have selected."}),"\n",(0,o.jsxs)(n.p,{children:["Two balancing algorithms are available. The first is ",(0,o.jsx)(n.code,{children:"round-robin"}),", and the second is ",(0,o.jsx)(n.code,{children:"least-sessions"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Now, let's consider a situation where you want to deploy the server and send all PSTN traffic to a conference room in Asterisk. For such a scenario, you must configure a Peer to represent your feature server and a Number to route calls from the PSTN."}),"\n",(0,o.jsx)(n.p,{children:"To do this, create a Peer configuration for your Asterisk server similar to the following:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v2beta1\nkind: Peer\nref: peer-01\nmetadata:\n  name: Asterisk (Media Server)\nspec:\n  aor: sip:conference@sip.local\n  username: asterisk\n  credentialsRef: credentials-01\n  loadBalancing:\n    withSessionAffinity: true\n    algorithm: least-sessions\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Notice that the load balancing section sets the ",(0,o.jsx)(n.code,{children:"withSessionAffinity"})," to ",(0,o.jsx)(n.code,{children:"true"}),". We need session affinity to ensure that all calls related to the conference arrive on the same Asterisk server."]}),"\n",(0,o.jsxs)(n.p,{children:["Every Asterisk server that registers using the ",(0,o.jsx)(n.code,{children:"asterisk"})," username will join the same group under the ",(0,o.jsx)(n.code,{children:"sip:conference@sip.local"})," Address of Record (AOR)."]}),"\n",(0,o.jsx)(n.h2,{id:"configuration-spec",children:"Configuration Spec"}),"\n",(0,o.jsx)(n.p,{children:"To configure the Location Service, you must provide a YAML or JSON configuration with the following structure."}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Property"}),(0,o.jsx)(n.th,{children:"Description"}),(0,o.jsx)(n.th,{children:"Required"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"region"})}),(0,o.jsx)(n.td,{children:"Reserved for future use"}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"bindAddr"})}),(0,o.jsx)(n.td,{children:"IPv4 interface on which to accept requests"}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"cache"})}),(0,o.jsx)(n.td,{children:"Cache configuration"}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"cache.provider"})}),(0,o.jsxs)(n.td,{children:["Cache provider (Accepts either ",(0,o.jsx)(n.code,{children:"memory"})," or ",(0,o.jsx)(n.code,{children:"redis"}),")"]}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"cache.parameters"})}),(0,o.jsx)(n.td,{children:"Cache parameters (Comma-separated key-value pairs)"}),(0,o.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"cache.parameters"})," property is only needed if you are using the Redis provider."]}),"\n",(0,o.jsx)(n.p,{children:"The following table shows the available parameters for the Redis provider."}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Property"}),(0,o.jsx)(n.th,{children:"Description"}),(0,o.jsx)(n.th,{children:"Required"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"username"})}),(0,o.jsx)(n.td,{children:"Username (if required by Redis)"}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"password"})}),(0,o.jsx)(n.td,{children:"Password (if required by Redis)"}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"host"})}),(0,o.jsxs)(n.td,{children:["Redis host (Defaults to ",(0,o.jsx)(n.code,{children:"localhost"}),")"]}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"port"})}),(0,o.jsxs)(n.td,{children:["Redis port (Defaults to ",(0,o.jsx)(n.code,{children:"6379"}),")"]}),(0,o.jsx)(n.td,{children:"No"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"secure"})}),(0,o.jsx)(n.td,{children:"Use secure connection for Redis"}),(0,o.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,o.jsx)(n.p,{children:"Here is an example of a configuration file:"}),"\n",(0,o.jsxs)(n.p,{children:["Filename: ",(0,o.jsx)(n.code,{children:"location.yaml"})," or ",(0,o.jsx)(n.code,{children:"location.json"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'kind: Location\napiVersion: v2beta1\nmetadata:\n  region: default\nspec:\n  bindAddr: 0.0.0.0:51902\n  cache:\n    provider: redis\n    parameters: "host=localhost,port=6379"\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Notice that using the ",(0,o.jsx)(n.code,{children:"memory"})," provider will only work for simple cases where you run a single instance of the Location Service. Suppose you need the ",(0,o.jsx)(n.code,{children:"least-session"})," algorithm and run multiple instances of the Location Service. In such cases, you will need the ",(0,o.jsx)(n.code,{children:"redis"})," provider."]}),"\n",(0,o.jsx)(n.h2,{id:"communication-and-protobuf-spec",children:"Communication and Protobuf Spec"}),"\n",(0,o.jsx)(n.p,{children:"Upstream service can communicate with the Location Service using gRPC. The following protobuf contains the definition of the Location Service API."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-protobuf",children:'syntax = "proto3";\n\npackage fonoster.routr.location.v2beta1;\n\nimport "google/protobuf/empty.proto";\nimport "common.proto";\nimport "processor.proto";\n\nservice Location {\n  rpc AddRoute (AddRouteRequest) returns (.google.protobuf.Empty) {}\n  rpc FindRoutes (FindRoutesRequest) returns (FindRoutesResponse) {}\n  rpc RemoveRoutes (RemoveRoutesRequest) returns (.google.protobuf.Empty) {}\n}\n\n// A binding created by an endpoint (Softphone, PBX, Conference System, etc.)\nmessage Route {\n  string user = 1;\n  string host = 2;\n  string port = 3;\n  string advertised_host = 13;\n  string advertised_port = 14;\n  fonoster.routr.common.v2beta1.Transport transport = 4;\n  int64 registered_on = 5;\n  int32 expires = 6;\n  int32 session_count = 7;\n  string edge_port_ref = 8;\n  repeated fonoster.routr.processor.v2beta1.NetInterface listening_points = 9;\n  repeated string localnets = 10;\n  repeated string external_addrs = 11;\n  // During route creation, an endpoint can request to add labels that can later be\n  // used as selectors. For example, a Softphone can add a label `priority=1` to indicate\n  // that it is the preferred endpoint for the given AOR.\n  map<string, string> labels = 12;\n}\n\nmessage AddRouteRequest {\n  // Address of record for the endpoint or trunk\n  string aor = 1;\n  Route route = 2;\n}\n\nmessage FindRoutesRequest {\n  message Backend {\n    enum Algoritm {\n      ROUND_ROBIN = 0;\n      LEAST_SESSIONS = 1;\n    }\n    string ref = 1;\n    bool with_session_affinity = 2;\n    Algoritm algorithm = 3;\n  }\n  string call_id = 1;\n  string aor = 2;\n  string session_affinity_ref = 3;\n  Backend backend = 4;\n  map<string, string> labels = 5;\n}\n\nmessage FindRoutesResponse {\n  repeated Route routes = 1;\n}\n\nmessage RemoveRoutesRequest {\n  string aor = 1;\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Upon receiving a valid ",(0,o.jsx)(n.code,{children:"AddRoute"})," request, the Location Service will add the route to the location table. The structure of the new Route resembles that of the Route message in the protobuf definition."]}),"\n",(0,o.jsxs)(n.p,{children:["Link to the ",(0,o.jsx)(n.a,{href:"https://github.com/fonoster/routr/blob/main/mods/common/src/protos/location.proto",children:"protobuf definition."})]}),"\n",(0,o.jsx)(n.h2,{id:"launching-the-location-service-with-docker",children:"Launching the Location Service with Docker"}),"\n",(0,o.jsxs)(n.p,{children:["The Location Service is available as a Docker image from ",(0,o.jsx)(n.a,{href:"https://hub.docker.com/r/fonoster/routr-location",children:"Docker Hub"}),". To launch the Location Service with Docker, you can use the following command:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker run -it -v $(pwd)/location.yaml:/etc/routr/location.yaml -p 51902:51902 fonoster/routr-location\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The previous example will pull the latest version of the Location Service from Docker Hub and launch it with the default configuration. The Location Service will listen to port ",(0,o.jsx)(n.code,{children:"51902"})," for gRPC requests. Remember, your Docker container must expose the ports in your configuration file. By default, the Dispatcher listens on port ",(0,o.jsx)(n.code,{children:"51902"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"quick-test-with-grpcurl",children:"Quick Test with gRPCurl"}),"\n",(0,o.jsxs)(n.p,{children:["One easy way to interact with the Location Service for testing and development is to use ",(0,o.jsx)(n.a,{href:"https://github.com/fullstorydev/grpcurl",children:"gRPCurl"}),". The following example shows how to send a request to the Location Service using gRPCurl:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"grpcurl -plaintext \\\n  -import-path /path/to/protos \\\n  -proto location.proto  -d '{...}' \\\n  localhost:51901 \\\n  fonoster.routr.location.v2beta1.Location/AddRouteRequest\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>c});var o=t(6540);const r={},s=o.createContext(r);function i(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);